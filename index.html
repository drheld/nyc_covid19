<tml>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NYC Covid Stats By Zip</title>

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-QD95PYGXPQ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-QD95PYGXPQ');
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.bundle.min.js" integrity="sha512-SuxO9djzjML6b9w9/I07IWnLnQhgyYVSpHZx0JV97kGBfTIsUYlWflyuW4ypnvhBrslz1yJ3R+S14fdCWmSmSA==" crossorigin="anonymous"></script>
  <script src="data.js"></script>
  <style type="text/css">
    #canvas-holder {
        background-color: #FFFFFF;
        top: 8px;
        left: 8px;
        right: 8px;
        bottom: 8px;
        height: 85%;
    }
    body {
      font-size: 100%;
      font-family: 'Roboto', sans-serif;
    }
  </style>
</head>

<body>
  <div id="selector">
    <form action="/nyc_covid19/" method="get">
      NYC Zip code: <input type="text" id="zip_input" name="zip">
      <input type="submit" value="Update">
    </form>
  </div>
  <div id="canvas-holder">
    <canvas id="official"></canvas>
  </div>
  <div id="disclaimer">
    Source data from <a href="https://github.com/nychealth/coronavirus-data">NYC Health</a>.
    <a href="https://github.com/drheld/nyc_covid19">Code</a>.
  </div>

  <script>
    var zip_code = '';
    if (window.location.hash) {
      zip_code = window.location.hash.substr(1);
    }
    const url_params = new URLSearchParams(window.location.search);
    if (url_params.has('zip')) {
      zip_code = url_params.get('zip');
    }
    document.getElementById('zip_input').value = zip_code;
    if (zip_code == '') {
      document.getElementById("canvas-holder").style.display="none";
    } else {
      gtag('user_properties', { zip: zip_code });
    }

    window.chartColors = {
      red: 'rgb(255, 99, 132)',
      orange: 'rgb(255, 159, 64)',
      yellow: 'rgb(255, 205, 86)',
      green: 'rgb(75, 192, 192)',
      blue: 'rgb(54, 162, 235)',
      light_blue: 'rgb(173, 216, 230)',
      purple: 'rgb(153, 102, 255)',
      grey: 'rgb(201, 203, 207)'
    };
    var color = Chart.helpers.color;

    var official_ctx = document.getElementById('official').getContext('2d');
    var official_cfg = {
      type: 'line',
      data: {
        labels: data['ny7daydates'],
        datasets: [{
          data: data['ny7daypositive'][zip_code],
          label: "New Daily Covid-19 Cases (7 day avg)",
          backgroundColor: color(window.chartColors.red).alpha(0.3).rgbString(),
          borderColor: color(window.chartColors.red).alpha(0.3).rgbString(),
          fill: true,
          yAxisID: 'testA'
        },
        {
          data: data['ny7daypercent'][zip_code],
          label: "Test Positivity % (7 day avg)",
          backgroundColor: color(window.chartColors.blue).alpha(0.5).rgbString(),
          borderColor: window.chartColors.blue,
          fill: false,
          yAxisID: 'percentA'
        }]
      },
      options: {
        maintainAspectRatio: false,
        scales: {
          xAxes: [
            {
              display: true,
              type: 'time',
              scaleLabel: {
                display: true,
                labelString: 'Date',
              },
              time: {
                parser: 'YYYY-MM-DD',
                tooltipFormat: 'YYYY-MM-DD',
                unit: 'day',
                unitStepSize: 1,
                displayFormats: {
                  'day': 'MM-DD'
                }
              },
            }
          ],
          yAxes: [
            {
              id: 'testA',
              position: 'left',
              ticks: {
                autoSkip: true,
              },
            }, {
              id: 'percentA',
              position: 'right',
              scaleLabel: {
                display: false,
                labelString: 'Percent Positive',
              },
              ticks: {
                autoSkip: true,
                callback: function(label, index, labels) { return label + '%'; },
              },
              gridLines: {
                drawOnChartArea: false,
              },
            },
          ],
        },
        title: {
          display: true,
          text: 'NYC Official Stats (' + zip_code + ')',
        },
      }
    };

    var has_data = data['ny7daypositive'][zip_code];
    if (has_data) {
      var official_chart = new Chart(official_ctx, official_cfg);
    } else {
      document.getElementById('canvas-holder').innerHTML = `
        Zip code not found. Only NYC zip codes are included.
        <p>
        Within NYC, some zip codes are not included as they are grouped with
        other zip codes as part of NYC's modified ZIP Code Tabulation Areas.
        For example, 11249 is included under 11211.
        <p>
        You can see a map of tabulation areas here:
        <br>
        <a href="https://data.beta.nyc/dataset/nyc-zip-code-tabulation-areas">
        https://data.beta.nyc/dataset/nyc-zip-code-tabulation-areas
        </a>
      `;
    }
  </script>
</body>

</html>
