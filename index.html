<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NYC Covid Stats By Zip</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.bundle.min.js" integrity="sha512-SuxO9djzjML6b9w9/I07IWnLnQhgyYVSpHZx0JV97kGBfTIsUYlWflyuW4ypnvhBrslz1yJ3R+S14fdCWmSmSA==" crossorigin="anonymous"></script>
  <script src="data.js"></script>
  <style type="text/css">
    #canvas-holder {
        background-color: #FFFFFF;
        top: 8px;
        left: 8px;
        right: 8px;
        bottom: 8px;
        height: 85%;
    }
    body {
      font-size: 100%;
    }
  </style>
</head>

<body>
  <div id="selector">
    <form action="/nyc_covid19/" method="get">
      NYC Zip code: <input type="text" id="zip_input" name="zip">
      <input type="submit" value="Update">
    </form>
  </div>
  <div id="canvas-holder">
    <canvas id="official"></canvas>
  </div>
  <div id="disclaimer">
    Source data from <a href="https://github.com/nychealth/coronavirus-data">NYC Health</a>.
  </div>

  <script>
    var zip_code = '';
    if (window.location.hash) {
      zip_code = window.location.hash.substr(1);
    }
    const url_params = new URLSearchParams(window.location.search);
    if (url_params.has('zip')) {
      zip_code = url_params.get('zip');
    }
    document.getElementById('zip_input').value = zip_code;
    if (zip_code == '') {
      document.getElementById("canvas-holder").style.display="none";
    }

    window.chartColors = {
      red: 'rgb(255, 99, 132)',
      orange: 'rgb(255, 159, 64)',
      yellow: 'rgb(255, 205, 86)',
      green: 'rgb(75, 192, 192)',
      blue: 'rgb(54, 162, 235)',
      light_blue: 'rgb(173, 216, 230)',
      purple: 'rgb(153, 102, 255)',
      grey: 'rgb(201, 203, 207)'
    };
    var color = Chart.helpers.color;

    var official_ctx = document.getElementById('official').getContext('2d');
    var official_cfg = {
      type: 'line',
      data: {
        labels: data['ny7daydates'],
        datasets: [{
          data: data['ny7daypositive'][zip_code],
          label: "7 Day Average Positive Count",
          backgroundColor: color(window.chartColors.red).alpha(0.3).rgbString(),
          borderColor: color(window.chartColors.red).alpha(0.3).rgbString(),
          fill: true,
          yAxisID: 'testA'
        },
        {
          data: data['ny7daypercent'][zip_code],
          label: "7-day Average % Positive",
          backgroundColor: color(window.chartColors.blue).alpha(0.5).rgbString(),
          borderColor: window.chartColors.blue,
          fill: false,
          yAxisID: 'percentA'
        }]
      },
      options: {
        maintainAspectRatio: false,
        scales: {
          xAxes: [
            {
              display: true,
              type: 'time',
              scaleLabel: {
                display: true,
                labelString: 'Date',
              },
              time: {
                parser: 'YYYY-MM-DD',
                tooltipFormat: 'YYYY-MM-DD',
                unit: 'day',
                unitStepSize: 1,
                displayFormats: {
                  'day': 'MM-DD'
                }
              },
            }
          ],
          yAxes: [
            {
              id: 'testA',
              position: 'left',
              ticks: {
                autoSkip: true,
              },
            }, {
              id: 'percentA',
              position: 'right',
              scaleLabel: {
                display: false,
                labelString: 'Percent Positive',
              },
              ticks: {
                autoSkip: true,
                callback: function(label, index, labels) { return label + '%'; },
              },
              gridLines: {
                drawOnChartArea: false,
              },
            },
          ],
        },
        title: {
          display: true,
          text: 'NYC Official Stats (' + zip_code + ')',
        },
      }
    };
    var official_chart = new Chart(official_ctx, official_cfg);
  </script>
</body>

</html>
